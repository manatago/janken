# 開発者ドキュメント

## システム構成

### ディレクトリ構造

```
/
├── .env                # 環境設定ファイル
├── index.php          # メインエントリーポイント
├── api/               # APIエンドポイント
│   ├── room.php      # ルーム管理API
│   └── game.php      # ゲーム状態管理API
├── js/               # フロントエンドスクリプト
│   ├── admin.js      # 管理者画面
│   ├── create_room.js # ルーム作成
│   ├── game.js       # ゲーム画面
│   └── name_input.js # 名前入力
├── css/              # スタイルシート
│   └── style.css     # 共通スタイル
├── templates/        # HTMLテンプレート
│   ├── admin.html    # 管理者画面
│   ├── create_room.html # ルーム作成
│   ├── game.html     # ゲーム画面
│   └── name_input.html # 名前入力
└── rooms/            # ルームデータ（動的に作成）
    └── [room_name]/  # 各ルームのデータ
        └── [player_name].txt # プレイヤーの選択

## 主要コンポーネントの説明

### バックエンド (PHP)

#### index.php
- メインエントリーポイント
- ルーティング処理
- テンプレート読み込み
- 環境変数の読み込み

#### api/room.php
- ルーム管理API
- ルームの作成・検証
- ディレクトリ操作

#### api/game.php
- ゲーム状態管理API
- プレイヤーの選択保存
- じゃんけん判定ロジック
- 状態同期

### フロントエンド (JavaScript)

#### admin.js
- 管理者認証
- Cookie管理
- ルーム作成画面への遷移

#### create_room.js
- ルーム作成処理
- URL生成
- エラーハンドリング

#### game.js
- じゃんけん選択UI
- 状態同期（3秒間隔）
- 結果表示
- もう一度遊ぶ機能

#### name_input.js
- 名前入力処理
- Cookie保存
- バリデーション

## データフロー

1. 管理者フロー
```
管理者URL確認 → 名前入力 → ルーム作成 → URL生成
```

2. 生徒フロー
```
ルームURL → 名前入力 → じゃんけん選択 → 結果待機 → 結果表示
```

3. 状態同期
```
クライアント ← API(GET) ← ファイルシステム
```

## セキュリティ考慮事項

1. 入力値バリデーション
- ルーム名: 英数字、ハイフン、アンダースコアのみ
- プレイヤー名: XSS対策
- じゃんけんの手: 定義済みの値のみ

2. ファイルシステム
- ディレクトリトラバーサル対策
- 適切なパーミッション設定

3. 認証
- 管理者認証はハッシュ化したキーを使用
- Cookie による状態管理

## エラーハンドリング

1. APIエラー
- 適切なHTTPステータスコード
- JSON形式のエラーメッセージ
- エラーログの出力

2. クライアントエラー
- ユーザーフレンドリーなエラーメッセージ
- 自動リトライ機能
- グレースフルデグラデーション

## 環境変数

- `APP_URL`: アプリケーションのベースURL
- `ADMIN_SECRET_KEY`: 管理者認証キー
- `ROOMS_DIR`: ルームデータ保存ディレクトリ

## パフォーマンス最適化

1. フロントエンド
- 効率的な状態チェック（3秒間隔）
- エラー時の適切なリカバリー
- 最小限のDOM操作

2. バックエンド
- ファイルシステムの効率的な利用
- 適切なキャッシュ制御
- 軽量な実装